from django.shortcuts import render
from django.http import HttpResponse

from main.forms import *
import os
import subprocess
import json

# Create your views here.
def home(request):
    return render(request, 'home.html', {

    })

def analysis(request):
    if request.POST:
        form = AnalysisForm(request.POST)
        if form.is_valid():
            if form.cleaned_data.get('dataset') == '1':
                result = []
                #locations = ['Towngas Cooking Centre', '三星台菜食堂 Tristar Kitchen', 'C.P.U. Cafe', 'Mini Friday', 'InterContinental Hong Kong', '東寶小館 Tung Po Kitchen']
                for file in sorted([f for f in os.listdir('./main/images/sample') if not f.startswith('.')]):
                    command = "./main/inference.py -image './main/images/sample/{}'".format(file)
                    print(command)
                    out = subprocess.check_output(command, shell=True)
                    result.append((str(out))[2:-3])
                print('final output', result)
                #json_data = json.dumps([{'food_category': food_category, 'location': location} for food_category, location in zip(result, locations)])
                json_data = json.dumps([{'food_category': food_category} for food_category in result])
                analysis = Analysis(result=json_data)
                analysis.save()
            if form.cleaned_data.get('dataset') == '2':
                json_data = [{"food_category": "hot_and_sour_soup"}, {"food_category": "Egg_Tart"}, {"food_category": "Pork_liver"}, {"food_category": "ice_cream"}, {"food_category": "hummus"}, {"food_category": "spaghetti_bolognese"}, {"food_category": "baby_back_ribs"}, {"food_category": "sashimi"}, {"food_category": "hummus"}, {"food_category": "spaghetti_carbonara"}, {"food_category": "Fried_chicken_drumsticks"}, {"food_category": "hot_and_sour_soup"}, {"food_category": "apple_pie"}, {"food_category": "macarons"}, {"food_category": "grilled_salmon"}, {"food_category": "fried_calamari"}, {"food_category": "Ice_cream"}, {"food_category": "churros"}, {"food_category": "takoyaki"}, {"food_category": "spaghetti_bolognese"}, {"food_category": "tuna_tartare"}, {"food_category": "donuts"}, {"food_category": "Steamed_Fish_Head_with_Diced_Hot_Red_Peppers"}, {"food_category": "chicken_curry"}, {"food_category": "frozen_yogurt"}, {"food_category": "crab_cakes"}, {"food_category": "macarons"}, {"food_category": "chicken_curry"}, {"food_category": "ice_cream"}, {"food_category": "paella"}, {"food_category": "ice_cream"}, {"food_category": "ramen"}, {"food_category": "shrimp_and_grits"}, {"food_category": "french_fries"}, {"food_category": "ice_cream"}, {"food_category": "White_fungus_soup"}, {"food_category": "hummus"}, {"food_category": "Sauteed_Shredded_Pork_in_Sweet_Bean_Sauce"}, {"food_category": "baby_back_ribs"}, {"food_category": "apple_pie"}, {"food_category": "Roast_pork"}, {"food_category": "huevos_rancheros"}, {"food_category": "grilled_cheese_sandwich"}, {"food_category": "pho"}, {"food_category": "ice_cream"}, {"food_category": "Biscuits"}, {"food_category": "Ice_cream"}, {"food_category": "Ice_cream"}, {"food_category": "Ice_cream"}, {"food_category": "Pork_ribs_soup_with_radish"}, {"food_category": "macarons"}, {"food_category": "Poached_Egg"}, {"food_category": "ice_cream"}, {"food_category": "Sauteed_bean_sprouts"}, {"food_category": "deviled_eggs"}, {"food_category": "ice_cream"}, {"food_category": "Ice_cream"}, {"food_category": "Ice_cream"}, {"food_category": "Egg_pudding"}, {"food_category": "spring_rolls"}, {"food_category": "Dumplings"}, {"food_category": "seaweed_salad"}, {"food_category": "ice_cream"}, {"food_category": "chocolate_mousse"}, {"food_category": "Ice_cream"}, {"food_category": "Ice_cream"}, {"food_category": "Ice_cream"}, {"food_category": "Ice_cream"}, {"food_category": "foie_gras"}, {"food_category": "hamburger"}, {"food_category": "Ice_cream"}, {"food_category": "ramen"}, {"food_category": "takoyaki"}, {"food_category": "ramen"}, {"food_category": "cup_cakes"}, {"food_category": "Fruit_salad"}, {"food_category": "strawberry_shortcake"}, {"food_category": "Saute_Spicy_Chicken"}, {"food_category": "bread_pudding"}, {"food_category": "Egg_pudding"}, {"food_category": "sushi"}, {"food_category": "grilled_salmon"}, {"food_category": "donuts"}, {"food_category": "grilled_salmon"}, {"food_category": "chicken_curry"}, {"food_category": "pork_chop"}, {"food_category": "macarons"}, {"food_category": "beef_tartare"}, {"food_category": "churros"}, {"food_category": "chocolate_cake"}, {"food_category": "frozen_yogurt"}, {"food_category": "pho"}, {"food_category": "hamburger"}, {"food_category": "greek_salad"}, {"food_category": "hot_dog"}, {"food_category": "hamburger"}, {"food_category": "bread_pudding"}, {"food_category": "panna_cotta"}, {"food_category": "cup_cakes"}, {"food_category": "gnocchi"}, {"food_category": "cup_cakes"}, {"food_category": "chocolate_mousse"}, {"food_category": "ice_cream"}, {"food_category": "peking_duck"}, {"food_category": "cannoli"}, {"food_category": "Ice_cream"}, {"food_category": "ice_cream"}, {"food_category": "Peanut"}, {"food_category": "ice_cream"}, {"food_category": "ice_cream"}, {"food_category": "ice_cream"}, {"food_category": "clam_chowder"}, {"food_category": "peking_duck"}, {"food_category": "ice_cream"}, {"food_category": "steak"}, {"food_category": "Ice_cream"}, {"food_category": "oysters"}, {"food_category": "deviled_eggs"}, {"food_category": "apple_pie"}, {"food_category": "ice_cream"}, {"food_category": "scallops"}, {"food_category": "poutine"}, {"food_category": "foie_gras"}, {"food_category": "frozen_yogurt"}, {"food_category": "sushi"}, {"food_category": "dumplings"}, {"food_category": "foie_gras"}, {"food_category": "sashimi"}, {"food_category": "oysters"}, {"food_category": "ice_cream"}, {"food_category": "hot_and_sour_soup"}, {"food_category": "Boiled_Fish_with_Picked_Cabbage_and_Chili"}, {"food_category": "Spicy_Chicken"}, {"food_category": "bibimbap"}, {"food_category": "caprese_salad"}, {"food_category": "hot_dog"}, {"food_category": "Cold_noodles"}, {"food_category": "Ice_cream"}, {"food_category": "chocolate_mousse"}, {"food_category": "Ice_cream"}, {"food_category": "hummus"}, {"food_category": "Biscuits"}, {"food_category": "filet_mignon"}, {"food_category": "ice_cream"}, {"food_category": "falafel"}, {"food_category": "poutine"}, {"food_category": "Ice_cream"}, {"food_category": "dumplings"}, {"food_category": "hummus"}, {"food_category": "ramen"}, {"food_category": "escargots"}, {"food_category": "Pork_ribs_soup_with_radish"}, {"food_category": "hummus"}, {"food_category": "lobster_bisque"}, {"food_category": "fried_rice_noodles"}, {"food_category": "foie_gras"}, {"food_category": "bread_pudding"}, {"food_category": "bread_pudding"}, {"food_category": "sushi"}, {"food_category": "Egg_pie_cake"}, {"food_category": "shrimp_and_grits"}, {"food_category": "Steamed_Fish_Head_with_Diced_Hot_Red_Peppers"}, {"food_category": "deviled_eggs"}, {"food_category": "garlic_bread"}, {"food_category": "beignets"}, {"food_category": "Beer_duck"}, {"food_category": "Saute_Spicy_Chicken"}, {"food_category": "beet_salad"}, {"food_category": "ice_cream"}, {"food_category": "ice_cream"}, {"food_category": "macarons"}, {"food_category": "Dumplings"}, {"food_category": "Boiled_Shredded_pork_in_chili_oil"}, {"food_category": "Pork_ribs_soup_with_radish"}, {"food_category": "Fruit_salad"}, {"food_category": "Minced_Pork_Congee_with_Preserved_Egg"}, {"food_category": "Spicy_crayfish"}, {"food_category": "Ice_cream"}, {"food_category": "foie_gras"}, {"food_category": "Mapo_Tofu"}, {"food_category": "caesar_salad"}, {"food_category": "ramen"}, {"food_category": "garlic_bread"}, {"food_category": "breakfast_burrito"}, {"food_category": "Ice_cream"}, {"food_category": "cheese_plate"}, {"food_category": "ramen"}, {"food_category": "pho"}, {"food_category": "macarons"}, {"food_category": "frozen_yogurt"}, {"food_category": "paella"}, {"food_category": "garlic_bread"}, {"food_category": "Egg_pudding"}, {"food_category": "foie_gras"}, {"food_category": "ramen"}, {"food_category": "pho"}, {"food_category": "Egg_pudding"}, {"food_category": "chicken_curry"}, {"food_category": "peking_duck"}, {"food_category": "oysters"}, {"food_category": "pho"}, {"food_category": "churros"}, {"food_category": "chocolate_cake"}, {"food_category": "frozen_yogurt"}, {"food_category": "Steamed_bun_with_purple_potato_and_pumpkin"}, {"food_category": "beignets"}, {"food_category": "Ice_cream"}, {"food_category": "pulled_pork_sandwich"}, {"food_category": "Ice_cream"}, {"food_category": "chicken_curry"}, {"food_category": "ice_cream"}, {"food_category": "ramen"}, {"food_category": "ice_cream"}, {"food_category": "risotto"}, {"food_category": "ramen"}, {"food_category": "Ice_cream"}, {"food_category": "foie_gras"}, {"food_category": "Grilled_fish"}, {"food_category": "ice_cream"}, {"food_category": "ice_cream"}, {"food_category": "Ice_cream"}, {"food_category": "Steamed_pork_with_rice_powder"}, {"food_category": "cannoli"}, {"food_category": "cheesecake"}, {"food_category": "Steamed_egg_custard"}, {"food_category": "Lamb_shashlik"}, {"food_category": "ramen"}, {"food_category": "Egg_pudding"}, {"food_category": "chocolate_cake"}, {"food_category": "hummus"}, {"food_category": "sashimi"}, {"food_category": "nachos"}, {"food_category": "lobster_bisque"}, {"food_category": "ceviche"}, {"food_category": "ice_cream"}, {"food_category": "hummus"}, {"food_category": "pancakes"}, {"food_category": "ice_cream"}, {"food_category": "tiramisu"}, {"food_category": "huevos_rancheros"}, {"food_category": "fried_rice"}, {"food_category": "croque_madame"}, {"food_category": "Steamed_Perch"}, {"food_category": "foie_gras"}, {"food_category": "ice_cream"}, {"food_category": "donuts"}, {"food_category": "chocolate_mousse"}, {"food_category": "Rice_porridge"}, {"food_category": "hummus"}, {"food_category": "cannoli"}]
                result = ['hot_and_sour_soup', 'Egg_Tart', 'Pork_liver', 'ice_cream', 'hummus', 'spaghetti_bolognese', 'baby_back_ribs', 'sashimi', 'hummus', 'spaghetti_carbonara', 'Fried_chicken_drumsticks', 'hot_and_sour_soup', 'apple_pie', 'macarons', 'grilled_salmon', 'fried_calamari', 'Ice_cream', 'churros', 'takoyaki', 'spaghetti_bolognese', 'tuna_tartare', 'donuts', 'Steamed_Fish_Head_with_Diced_Hot_Red_Peppers', 'chicken_curry', 'frozen_yogurt', 'crab_cakes', 'macarons', 'chicken_curry', 'ice_cream', 'paella', 'ice_cream', 'ramen', 'shrimp_and_grits', 'french_fries', 'ice_cream', 'White_fungus_soup', 'hummus', 'Sauteed_Shredded_Pork_in_Sweet_Bean_Sauce', 'baby_back_ribs', 'apple_pie', 'Roast_pork', 'huevos_rancheros', 'grilled_cheese_sandwich', 'pho', 'ice_cream', 'Biscuits', 'Ice_cream', 'Ice_cream', 'Ice_cream', 'Pork_ribs_soup_with_radish', 'macarons', 'Poached_Egg', 'ice_cream', 'Sauteed_bean_sprouts', 'deviled_eggs', 'ice_cream', 'Ice_cream', 'Ice_cream', 'Egg_pudding', 'spring_rolls', 'Dumplings', 'seaweed_salad', 'ice_cream', 'chocolate_mousse', 'Ice_cream', 'Ice_cream', 'Ice_cream', 'Ice_cream', 'foie_gras', 'hamburger', 'Ice_cream', 'ramen', 'takoyaki', 'ramen', 'cup_cakes', 'Fruit_salad', 'strawberry_shortcake', 'Saute_Spicy_Chicken', 'bread_pudding', 'Egg_pudding', 'sushi', 'grilled_salmon', 'donuts', 'grilled_salmon', 'chicken_curry', 'pork_chop', 'macarons', 'beef_tartare', 'churros', 'chocolate_cake', 'frozen_yogurt', 'pho', 'hamburger', 'greek_salad', 'hot_dog', 'hamburger', 'bread_pudding', 'panna_cotta', 'cup_cakes', 'gnocchi', 'cup_cakes', 'chocolate_mousse', 'ice_cream', 'peking_duck', 'cannoli', 'Ice_cream', 'ice_cream', 'Peanut', 'ice_cream', 'ice_cream', 'ice_cream', 'clam_chowder', 'peking_duck', 'ice_cream', 'steak', 'Ice_cream', 'oysters', 'deviled_eggs', 'apple_pie', 'ice_cream', 'scallops', 'poutine', 'foie_gras', 'frozen_yogurt', 'sushi', 'dumplings', 'foie_gras', 'sashimi', 'oysters', 'ice_cream', 'hot_and_sour_soup', 'Boiled_Fish_with_Picked_Cabbage_and_Chili', 'Spicy_Chicken', 'bibimbap', 'caprese_salad', 'hot_dog', 'Cold_noodles', 'Ice_cream', 'chocolate_mousse', 'Ice_cream', 'hummus', 'Biscuits', 'filet_mignon', 'ice_cream', 'falafel', 'poutine', 'Ice_cream', 'dumplings', 'hummus', 'ramen', 'escargots', 'Pork_ribs_soup_with_radish', 'hummus', 'lobster_bisque', 'fried_rice_noodles', 'foie_gras', 'bread_pudding', 'bread_pudding', 'sushi', 'Egg_pie_cake', 'shrimp_and_grits', 'Steamed_Fish_Head_with_Diced_Hot_Red_Peppers', 'deviled_eggs', 'garlic_bread', 'beignets', 'Beer_duck', 'Saute_Spicy_Chicken', 'beet_salad', 'ice_cream', 'ice_cream', 'macarons', 'Dumplings', 'Boiled_Shredded_pork_in_chili_oil', 'Pork_ribs_soup_with_radish', 'Fruit_salad', 'Minced_Pork_Congee_with_Preserved_Egg', 'Spicy_crayfish', 'Ice_cream', 'foie_gras', 'Mapo_Tofu', 'caesar_salad', 'ramen', 'garlic_bread', 'breakfast_burrito', 'Ice_cream', 'cheese_plate', 'ramen', 'pho', 'macarons', 'frozen_yogurt', 'paella', 'garlic_bread', 'Egg_pudding', 'foie_gras', 'ramen', 'pho', 'Egg_pudding', 'chicken_curry', 'peking_duck', 'oysters', 'pho', 'churros', 'chocolate_cake', 'frozen_yogurt', 'Steamed_bun_with_purple_potato_and_pumpkin', 'beignets', 'Ice_cream', 'pulled_pork_sandwich', 'Ice_cream', 'chicken_curry', 'ice_cream', 'ramen', 'ice_cream', 'risotto', 'ramen', 'Ice_cream', 'foie_gras', 'Grilled_fish', 'ice_cream', 'ice_cream', 'Ice_cream', 'Steamed_pork_with_rice_powder', 'cannoli', 'cheesecake', 'Steamed_egg_custard', 'Lamb_shashlik', 'ramen', 'Egg_pudding', 'chocolate_cake', 'hummus', 'sashimi', 'nachos', 'lobster_bisque', 'ceviche', 'ice_cream', 'hummus', 'pancakes', 'ice_cream', 'tiramisu', 'huevos_rancheros', 'fried_rice', 'croque_madame', 'Steamed_Perch', 'foie_gras', 'ice_cream', 'donuts', 'chocolate_mousse', 'Rice_porridge', 'hummus', 'cannoli']
            if form.cleaned_data.get('dataset') == '3':
                result = []
                for file in sorted([f for f in os.listdir('./main/images/all') if not f.startswith('.')]):
                    command = "./main/inference.py -image './main/images/all/{}'".format(file)
                    print(command)
                    out = subprocess.check_output(command, shell=True)
                    result.append((str(out))[2:-3])
                print('final output', result)
                json_data = json.dumps([{'food_category': category} for category in result])
                analysis = Analysis(result=json_data)
                analysis.save()
            print(json_data)
            return render(request, 'analysis_result.html', {
                'dataset': form.cleaned_data.get('dataset'),
                'json_data': json_data,
                'result': json.dumps(result)
            })

    else:
        form = AnalysisForm()
    return render(request, 'analysis.html', {
        'form': form,
    })
